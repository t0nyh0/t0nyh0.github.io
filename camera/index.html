<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartShoot Super Camera</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        .monitor {
            object-fit: cover;
            width: 100vw;
            height: 100vh;
            border: 0;
        }
    </style>
</head>
<body class="font-sans bg-black touch-none">
    <div id="app" class="fixed inset-0">
        <video class="monitor" ref="video" autoplay playsinline></video>
        <div class="absolute inset-0 opacity-50">
            <div class="absolute top-1/3 w-full h-px bg-white"></div>
            <div class="absolute top-2/3 w-full h-px bg-white"></div>
            <div class="absolute left-1/3 h-full w-px bg-white"></div>
            <div class="absolute left-2/3 h-full w-px bg-white"></div>
        </div>
        <canvas ref="canvas" class="hidden"></canvas>

        <div class="flex items-center justify-center fixed"
            :class="[orientation === 'portrait' ? 'flex-row bottom-0 left-0 right-0 py-8' : 'flex-col top-0 right-0 bottom-0 px-8']">
            <div class="flex-1 justify-center flex m-2" :class="[orientation === 'portrait' ? 'flex-row' : 'flex-col']">
                <div class="px-2 py-1 rounded-md bg-white font-semibold text-sm opacity-80" @click="changeIso" v-if="tools.includes('iso')">{{iso}}</div>
            </div>
            <div
                :class="[orientation === 'portrait' ? 'mx-8' : 'my-8']"
            >
                <button @click="captureImage" class="w-16 h-16 bg-white border-4 border-gray-300 rounded-full relative flex items-center justify-center">
                    <div class="w-12 h-12 bg-white rounded-full"></div>
                </button>
            </div>
            <div class="flex-1 justify-center flex m-2 " :class="[orientation === 'portrait' ? 'flex-row' : 'flex-col']" @click="showCapabilities = true">
                <i class="fa fa-circle-info text-white opacity-80 text-2xl"></i>
            </div>
        </div>

        <div class="fixed inset-0 bg-blue-400 bg-opacity-100 z-10 p-6" v-if="showCapabilities">
            <h1 class="text-lg font-bold mb-4">Camera Capabilities</h1>

            <p class="text-xs text-pretty">
                <p v-for="capability in capabilities"><strong>{{capability.key}}</strong>: {{JSON.stringify(capability)}}</p>
            </p>

            <button @click="showCapabilities = false" class="absolute top-4 right-4 ">
                <i class="fa fa-times text-2xl text-white"></i>
            </button>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        let track = null

        createApp({
            setup() {
                const video = ref(null);
                const canvas = ref(null);
                const orientation = ref('portrait')
                const capabilities = ref(null);
                const tools = ref([])
                const showCapabilities = ref(false);
                const iso = ref(400);

                onMounted(async () => {
                    screen.orientation.addEventListener("change", () => {
                        onOrientationChange()
                        onLoadStream()
                    })

                    orientation.value = screen.orientation.type.split('-')[0] || 'portrait'
                    onLoadStream()
                });

                const onLoadStream = async () => {
                    const mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", aspectRatio: orientation.value === 'landscape' ? 16/9 : 9/16, iso: iso.value } })
                    video.value.srcObject = mediaStream;

                    track = mediaStream.getVideoTracks()[0];
                    track.applyConstraints({iso: iso.value})

                    const tc = track.getCapabilities()

                    const EXCLUDE_CAPABILITIES = ['deviceId', 'groupId']
                    capabilities.value = Object
                        .keys(tc)
                        .filter(key => !EXCLUDE_CAPABILITIES.includes(key))
                        .map((key) => Object.assign({}, { key }, tc[key]));

                        tools.value = capabilities.value.map(capability => capability.key)
                }

                const onOrientationChange = () => {
                    if (screen.orientation.type.includes('landscape')) {
                        orientation.value = 'landscape';
                    } else {
                        orientation.value = 'portrait';
                    }
                }

                const captureImage = () => {
                    if (!video.value || !canvas.value) return;

                    const context = canvas.value.getContext('2d');
                    canvas.value.width = video.value.videoWidth;
                    canvas.value.height = video.value.videoHeight;
                    context.drawImage(video.value, 0, 0, canvas.value.width, canvas.value.height);

                    const imageData = canvas.value.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = imageData;
                    a.download = 'captured_image.png';
                    a.click();
                };

                const changeIso = () => {
                    iso.value = iso.value < 800 ? iso.value + 100 : 100;
                    onLoadStream()
                }

                return { video, canvas, captureImage, orientation, capabilities, showCapabilities, iso, changeIso, tools };
            }
        }).mount('#app');
    </script>
</body>
</html>
